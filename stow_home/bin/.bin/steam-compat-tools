#!/usr/bin/env bash
dstpath="$HOME/.steam/root/compatibilitytools.d"
# proton-ge
gebaseuri="https://github.com/GloriousEggroll/proton-ge-custom/releases/latest"
gelatesturi="https://api.github.com/repos/GloriousEggroll/proton-ge-custom/releases/latest"
# luxtorpeda
ltpbaseuri="https://github.com/luxtorpeda-dev/luxtorpeda/releases/latest"
ltplatesturi="https://api.github.com/repos/luxtorpeda-dev/luxtorpeda/releases/latest"
# boxtron
boxbaseuri="https://github.com/dreamer/boxtron/releases/latest"
boxplatesturi="https://api.github.com/repos/dreamer/boxtron/releases/latest"
# latest ver
gelatestversion="$(curl -s $gelatesturi | egrep -m1 "tag_name" | cut -d \" -f4)"
ltplatestversion="$(curl -s $ltplatesturi | egrep -m1 "tag_name" | cut -d \" -f4)"
boxatestversion="$(curl -s $boxlatesturi | egrep -m1 "tag_name" | cut -d \" -f4)"
# proton-ge get
if [[ -d $dstpath/Proton-$gelatestversion ]]
then
  echo "Proton $gelatestversion is the latest version and is already installed."
  echo "Exiting..."
  exit 0
else
  echo "Proton $gelatestversion is the latest version and is not installed yet."
  echo "Installing Proton $gelatestverion"
  geurl=$(curl -s $gelatesturi | egrep -m1 "browser_download_url.*.tar.gz" | cut -d \" -f4)
fi
# ltp get
if [[ -d $dstpath/luxtorpeda-$ltplatestversion ]]
then
  echo "luxtorpeda $ltplatestversion is the latest version and is already installed."
  echo "Exiting..."
  exit 0
else
  echo "lutorpeda $ltplatestversion is the latest version and is not installed yet."
  echo "Installing luxtorpeda $ltpgelatestverion"
  ltpurl=$(curl -s $ltplatesturi | egrep -m1 "browser_download_url.*.tar.gz" | cut -d \" -f4)
fi

if [[ -d $dstpath/boxtron-$gelatestversion ]]
then
  echo "boxtron $boxlatestversion is the latest version and is already installed."
  echo "Exiting..."
  exit 0
else
  echo "boxtron $boxlatestversion is the latest version and is not installed yet."
  echo "Installing boxtron $boxlatestverion"
  boxurl=$(curl -s $boxlatesturi | egrep -m1 "browser_download_url.*.tar.gz" | cut -d \" -f4)
fi

gersp="$(curl -sI "$geurl" | head -1)"
echo "$gersp" | grep -q 302 || {
  echo "$gersp"
  exit 1
}

ltprsp="$(curl -sI "$ltpurl" | head -1)"
echo "$ltprsp" | grep -q 302 || {
  echo "$ltprsp"
  exit 1
}

boxrsp="$(curl -sI "$boxurl" | head -1)"
echo "$boxrsp" | grep -q 302 || {
  echo "$boxrsp"
  exit 1
}

[ -d "$dstpath" ] || {
    mkdir "$dstpath"
    echo [Info] Created "$dstpath"
}

curl -sL "$geurl" | tar xfzv - -C "$dstpath"
curl -sL "$ltpurl" | tar xfzv - -C "$dstpath"
curl -sL "$boxurl" | tar xfzv - -C "$dstpath"
